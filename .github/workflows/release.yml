name: Automatic Release

on:
  workflow_run:
    workflows: ["build"]
    branches: [main]
    types:
      - completed

permissions:
  contents: write
  actions: read

jobs:
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Get version from gradle.properties
        id: get_version
        run: |
          VERSION=$(grep '^mod_version=' gradle.properties | cut -d'=' -f2)
          ARCHIVE=$(grep '^archives_base_name=' gradle.properties | cut -d'=' -f2)
          CLEAN_VERSION=$(echo "$VERSION" | sed 's/-for-.*$//')
          MC_VERSION=$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "archive=$ARCHIVE" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT
          echo "Version complÃ¨te: $VERSION"
          echo "Archive base: $ARCHIVE"
          echo "Version clean: $CLEAN_VERSION"
          echo "MC: $MC_VERSION"

      - name: Download build artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          run_id: ${{ github.event.workflow_run.id }}
          name: Artifacts
          path: artifacts
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove sources.jar
        run: find artifacts -name "*-sources.jar" -delete

      - name: Rename JAR for GitHub Release asset
        run: |
          set -e
          SRC="artifacts/${{ steps.get_version.outputs.archive }}-${{ steps.get_version.outputs.version }}.jar"
          if [ ! -f "$SRC" ]; then
            echo "Primary jar not found at $SRC; searching fallbackâ€¦"
            SRC=$(find artifacts -type f -name "*.jar" | head -n 1)
          fi
          DEST="artifacts/Dailyrewards-${{ steps.get_version.outputs.clean_version }}-for-1.21.5.jar"
          echo "Renaming $SRC -> $DEST"
          if [ "$SRC" = "$DEST" ]; then
            echo "Already correctly named: $SRC"
          else
            mv "$SRC" "$DEST"
          fi
          ls -l artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.clean_version }}
          name: "DailyRewards v${{ steps.get_version.outputs.clean_version }}"
          body: |
            ## ğŸ DailyRewards v${{ steps.get_version.outputs.clean_version }}
            
            **ğŸ“¥ Download:** `${{ steps.get_version.outputs.archive }}-${{ steps.get_version.outputs.version }}.jar`
            
            **ğŸ”§ Compatibility:**
            - Minecraft 1.21.5
            - Fabric Loader 0.16.14+
            - Fabric API required
            
            **ğŸ“‹ Changes:**
            Build from commit: ${{ github.sha }}
            
            **ğŸ”— Links:**
            - [Modrinth Page](https://modrinth.com/mod/hypixel-dailyrewards)
            - [GitHub Repository](https://github.com/Cqseur/DailyRewards)
            
          prerelease: false
          draft: false  
          files: |
            artifacts/**/*.jar
